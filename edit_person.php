<?php//Check if user is legitimately logged in$loginfile = "/etc/login";$fh = fopen($loginfile, 'r') or die("can't open file");$login = fread($fh, filesize($loginfile));fclose($fh);if ($login == 0) {echo "<br /><br /><div align='center'><font face='arial'>You are not logged on. Please click <a href='/index.html' target='_top'>here</a></font></div>";exit;}?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html> <head> <title>Controlsoft iWeb</title> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <link href="tab.css" rel="stylesheet" type="text/css" /></head> <body class="section-2"> <div id="frame"> <div id="left"><div id="logo"><img src="Images/cslogo.jpg"/><?phpecho date('d/m/Y <br /> H:i:s');?></div><div id="logout"><a href="logout.php"><img src="Images/delete_32x32.png"/>Logout</a></div></div><div id="main"><ul id="menu">   <li id="nav-1"><a href="access.php"><img src="Images/round_ok_32x32.png"/>Events</a></li>   <li id="nav-2"><a href="person.php"><img src="Images/user_32x32.png"/>People</a></li>   <li id="nav-3"><a href="reader.php"><img src="Images/door_32x32.png"/>Doors</a></li>   <li id="nav-4"><a href="settings.php"><img src="Images/wrench_32x32.png"/>Settings</a></li></ul> <div id="contents">
<?phpinclude "functions.php";
$checked1="";
$checked2="";
$action = $_GET['action'];$EmployeeID = $_GET['EmployeeID'];
$TagID = $_GET['TagID'];
switch ($action)
{
case 'edit':
$i=1;
$connect = new PDO("sqlite:/home/ems/web.db");

$sql = "SELECT * FROM employee WHERE EmployeeID=$EmployeeID";

$sqlr = "SELECT * FROM systemscanners";

//This is where you display your query results

foreach ($connect->query($sql) as $info) 
{ 
$FirstNames=$info['FirstNames'];
$Surname=$info['Surname'];
$EmployeeID=$info['EmployeeID'];
$TagID=$info['TagID'];
$AccompaniedType=$info['AccompaniedType'];
$AccompaniedID=$info['AccompaniedID'];
echo "<table border='0' align='center'><td><table border='0' align='center' bgcolor='white'><form name='form' action='update_person.php' method='get'><tr><td colspan='2' align='center'><b>Edit Person</b></td></tr><tr><td>First Names: </td><td><input type='text' name='fname' value='$FirstNames'/></td></tr><tr><td>Surname: </td><td><input type='text' name='surname' value='$Surname'/></td></tr><tr><td>ID Card: </td><td><input type='text' name='tagid' title='You cannot assign a new ID card to this person. Disable the old ID card and assign a new one.' readonly='readonly' value='$TagID'/><input type='hidden' name='empid' value='$EmployeeID'/></td></tr><tr><td colspan='2' align='center'>Allow access at:</td></tr>";
foreach ($connect->query($sqlr) as $info) 
{
$ScannerID=$info['ScannerID'];
$Name=$info['Name'];
${r.$i}=$Name;
$i++;
}

//if ($AccompaniedType==1 && $r1!="" )if ($AccompaniedType == '1')
{
$checked1="checked";
}echo "<tr><td colspan='2' align='center'><input type='checkbox' name='1' value='1' $checked1 /> &nbsp; $r1</td></tr>";
//if ($AccompaniedID==1 && $r2!="" )if ($AccompaniedID == '1')
{
$checked2="checked";}echo "<tr><td colspan='2' align='center'><input type='checkbox' name='2' value='1' $checked2 /> &nbsp; $r2</td></tr>";echo "<tr><td colspan='2'>&nbsp;</td></tr><tr align='center'><td>&nbsp;</td><td><table border='0' align='center' bgcolor='white'><tr><td><input type='submit' name='Submit' value='  OK   ' /></form></td><form action='person.php' method='get'><td><input type='submit' value='Cancel'></form></td></tr></td></table></tr></table></td></table>";
}
break;
case 'disable':
$connect = new PDO("sqlite:/home/ems/web.db");
//$sql = "DELETE FROM employee WHERE EmployeeID=$EmployeeID";$sql = "UPDATE employee SET Enabled='0' WHERE EmployeeID='$EmployeeID'";$sqle = "SELECT * FROM employee WHERE EmployeeID=$EmployeeID";foreach ($connect->query($sqle) as $info) { $tagid=$info['TagID'];}
$connect->exec($sql);	//*******************New code to suspend the person to the reader without having to stop and start ems.****************	//The only concern is that the person's record will stay in ems.db (and therefore ems itself) forever, but will not be displayed in the webpages by web.db...	$part3 = $tagid;//The first part of the message 0030 session, 10 disable tag (16)$message = '003010';$part2 = $message;//Add the card string$message .= $tagid;//Add the rest of the message//$part4 = '00030000000001000000000000';//$message .= '00030000000001000000000000';//Determine the total length of the message, + the >, ASCII null character and hex byte checksum (4 characters in total)$length = (strlen($message))+6;//Convert the value to hex$length = dechex ( $length );//Convert lowercase hex letters to uppercase so the XOR checksum calculations are correct.$caps_length = '';for ($i = 0, $j = strlen($length); $i < $j; $i++) {    if ('0' == $length[$i]) {$caps_length .='0';}	elseif ('1' == $length[$i]) {$caps_length .='1';}	elseif ('2' == $length[$i]) {$caps_length .='2';}	elseif ('3' == $length[$i]) {$caps_length .='3';}	elseif ('4' == $length[$i]) {$caps_length .='4';}	elseif ('5' == $length[$i]) {$caps_length .='5';}	elseif ('6' == $length[$i]) {$caps_length .='6';}	elseif ('7' == $length[$i]) {$caps_length .='7';}	elseif ('8' == $length[$i]) {$caps_length .='8';}	elseif ('9' == $length[$i]) {$caps_length .='9';}	elseif ('a' == $length[$i]) {$caps_length .='A';}	elseif ('b' == $length[$i]) {$caps_length .='B';}	elseif ('c' == $length[$i]) {$caps_length .='C';}	elseif ('d' == $length[$i]) {$caps_length .='D';}	elseif ('e' == $length[$i]) {$caps_length .='E';}	elseif ('f' == $length[$i]) {$caps_length .='F';}}//Assemble the string to be sent (note the ASCII null character will not affect the checksum calculation so is not included here)$string = '>';$string .= $caps_length;$part1 = $string;$string .= $message;//Calculate the checksum$x = 0;$conversion = '';for ($i = 0, $j = strlen($string); $i < $j; $i++) {    if ('0' == $string[$i]) {$conversion .='48^';}	elseif ('1' == $string[$i]) {$conversion .='49^';}	elseif ('2' == $string[$i]) {$conversion .='50^';}	elseif ('3' == $string[$i]) {$conversion .='51^';}	elseif ('4' == $string[$i]) {$conversion .='52^';}	elseif ('5' == $string[$i]) {$conversion .='53^';}	elseif ('6' == $string[$i]) {$conversion .='54^';}	elseif ('7' == $string[$i]) {$conversion .='55^';}	elseif ('8' == $string[$i]) {$conversion .='56^';}	elseif ('9' == $string[$i]) {$conversion .='57^';}	elseif ('>' == $string[$i]) {$conversion .='62^';}	elseif ('A' == $string[$i]) {$conversion .='65^';}	elseif ('B' == $string[$i]) {$conversion .='66^';}	elseif ('C' == $string[$i]) {$conversion .='67^';}	elseif ('D' == $string[$i]) {$conversion .='68^';}	elseif ('E' == $string[$i]) {$conversion .='69^';}	elseif ('F' == $string[$i]) {$conversion .='70^';}}//Add on an extra 0. Makes no difference to the final value, but in necessary so as not to end the expression with ^.$conversion .='0';eval("\$checksum = " . $conversion . ";");$checksum = dechex ( $checksum );//Convert lowercase hex letters to uppercase$final_checksum = '';for ($i = 0, $j = strlen($checksum); $i < $j; $i++) {    if ('0' == $checksum[$i]) {$final_checksum .='0';}	elseif ('1' == $checksum[$i]) {$final_checksum .='1';}	elseif ('2' == $checksum[$i]) {$final_checksum .='2';}	elseif ('3' == $checksum[$i]) {$final_checksum .='3';}	elseif ('4' == $checksum[$i]) {$final_checksum .='4';}	elseif ('5' == $checksum[$i]) {$final_checksum .='5';}	elseif ('6' == $checksum[$i]) {$final_checksum .='6';}	elseif ('7' == $checksum[$i]) {$final_checksum .='7';}	elseif ('8' == $checksum[$i]) {$final_checksum .='8';}	elseif ('9' == $checksum[$i]) {$final_checksum .='9';}	elseif ('a' == $checksum[$i]) {$final_checksum .='A';}	elseif ('b' == $checksum[$i]) {$final_checksum .='B';}	elseif ('c' == $checksum[$i]) {$final_checksum .='C';}	elseif ('d' == $checksum[$i]) {$final_checksum .='D';}	elseif ('e' == $checksum[$i]) {$final_checksum .='E';}	elseif ('f' == $checksum[$i]) {$final_checksum .='F';}}//If the checksum is only one character, then make it 2. Eg. make 8 into 08 or A into 0Aif (strlen($final_checksum)==1) {$new_final_checksum = '0';$new_final_checksum .= $final_checksum;$new_final_checksum = $final_checksum;}//The final string to be sent to the controller must now be assembled and sent:$string .=$final_checksum;$part5 = $final_checksum;$final_string = $part1 . $part2 . $part3 . chr(0) . $part5 . chr(13);//Don't timeoutset_time_limit(0);//Socket connection info$host="10.0.1.230";  // ****REMEMBER read the IP file in case the host IP is not default$port = 5556;// open a client connection$fp = fsockopen ($host, $port, $errno, $errstr);if (!$fp){$result = "Error: could not open socket connection";}//Logon message$message = ">1D003003000001000107D0119435";$message .= chr(13);// write the string contained in $message to the socketfputs ($fp, $message);sleep(1);// get the result//$result = fgets ($fp, 64);//echo "The controller says: $result <br /><br />";//Keepalive message$message1 = ">0B00300748";$message1 .= chr(13);fputs ($fp, $message1);sleep(1);//$result1 = fgets ($fp, 64);//echo "The controller says: $result1 <br /><br />";//Send card data$message2 = $final_string;fputs ($fp, $message2);sleep(1);//$result2 = fgets ($fp, 64);//echo "The controller says: $result2";// close the connectionfclose ($fp);
echo "<meta http-equiv='refresh' content='0;URL=person.php'>"; 
//echo $message2;
break;
case 'add':$i=1;$connect = new PDO("sqlite:/home/ems/web.db");$sqlr = "SELECT * FROM systemscanners";echo "<table border='0' align='center'><td><table border='0' align='center' bgcolor='white'><form name='form' action='add_person.php' method='get'><tr><td colspan='2' align='center'><b>Add Person</b></td></tr><tr><td>First Names: </td><td><input type='text' name='fname' /></td></tr><tr><td>Surname: </td><td><input type='text' name='surname' /></td></tr><tr><td>ID Card: </td><td><input type='text' name='tagid' value='$TagID'/><input type='hidden' name='empid' /></td></tr><tr><td></td><td>Allow access at:</td></tr>";foreach ($connect->query($sqlr) as $info){$ScannerID=$info['ScannerID'];$Name=$info['Name'];echo "<tr><td></td><td><input type='checkbox' name='$i' value='$ScannerID' /> &nbsp; $Name</td></tr>";$i++;}echo "<input type='hidden' name='number' value='$i' /><tr><td>&nbsp;</td><td></td></tr><tr align='center'><td>&nbsp;</td><td><table border='0' align='center' bgcolor='white'><tr><td><input type='submit' name='Submit' value='  OK   ' /></form></td><form action='person.php' method='get'><td><input type='submit' value='Cancel'></form></td></tr></td></table></tr></table></td></table>";break;case 'enable':$connect = new PDO("sqlite:/home/ems/web.db");$sql = "UPDATE employee SET Enabled='1' WHERE EmployeeID='$EmployeeID'";$sqle = "SELECT * FROM employee WHERE EmployeeID=$EmployeeID";foreach ($connect->query($sqle) as $info) { $tagid=$info['TagID'];}$connect->exec($sql);$part3 = $tagid;//The first part of the message 0030 session, 0F update tag (15)$message = '00300F';$part2 = $message;//Add the card string$message .= $tagid;//Add the rest of the message//$part4 = '00030000000001000000000000';//$message .= '00030000000001000000000000';$part4 = '010001';$message .= $part4;//Determine the total length of the message, + the >, hex byte length, ASCII null character and hex byte checksum$length = (strlen($message))+6;//Convert the value to hex$length = dechex ( $length );//Convert lowercase hex letters to uppercase so the XOR checksum calculations are correct.//First inialise $caps_length variable$caps_length = '';for ($i = 0, $j = strlen($length); $i < $j; $i++) {    if ('0' == $length[$i]) {$caps_length .='0';}	elseif ('1' == $length[$i]) {$caps_length .='1';}	elseif ('2' == $length[$i]) {$caps_length .='2';}	elseif ('3' == $length[$i]) {$caps_length .='3';}	elseif ('4' == $length[$i]) {$caps_length .='4';}	elseif ('5' == $length[$i]) {$caps_length .='5';}	elseif ('6' == $length[$i]) {$caps_length .='6';}	elseif ('7' == $length[$i]) {$caps_length .='7';}	elseif ('8' == $length[$i]) {$caps_length .='8';}	elseif ('9' == $length[$i]) {$caps_length .='9';}	elseif ('a' == $length[$i]) {$caps_length .='A';}	elseif ('b' == $length[$i]) {$caps_length .='B';}	elseif ('c' == $length[$i]) {$caps_length .='C';}	elseif ('d' == $length[$i]) {$caps_length .='D';}	elseif ('e' == $length[$i]) {$caps_length .='E';}	elseif ('f' == $length[$i]) {$caps_length .='F';}}//Assemble the string to be sent (note the ASCII null character will not affect the checksum calculation so is not included here)$string = '>';$string .= $caps_length;$part1 = $string;$string .= $message;//Calculate the checksum$x = 0;$conversion = '';for ($i = 0, $j = strlen($string); $i < $j; $i++) {    if ('0' == $string[$i]) {$conversion .='48^';}	elseif ('1' == $string[$i]) {$conversion .='49^';}	elseif ('2' == $string[$i]) {$conversion .='50^';}	elseif ('3' == $string[$i]) {$conversion .='51^';}	elseif ('4' == $string[$i]) {$conversion .='52^';}	elseif ('5' == $string[$i]) {$conversion .='53^';}	elseif ('6' == $string[$i]) {$conversion .='54^';}	elseif ('7' == $string[$i]) {$conversion .='55^';}	elseif ('8' == $string[$i]) {$conversion .='56^';}	elseif ('9' == $string[$i]) {$conversion .='57^';}	elseif ('>' == $string[$i]) {$conversion .='62^';}	elseif ('A' == $string[$i]) {$conversion .='65^';}	elseif ('B' == $string[$i]) {$conversion .='66^';}	elseif ('C' == $string[$i]) {$conversion .='67^';}	elseif ('D' == $string[$i]) {$conversion .='68^';}	elseif ('E' == $string[$i]) {$conversion .='69^';}	elseif ('F' == $string[$i]) {$conversion .='70^';}}//Add on an extra 0. Makes no difference to the final value, but in necessary so as not to end the expression with ^.$conversion .='0';eval("\$checksum = " . $conversion . ";");$checksum = dechex ( $checksum );//Convert lowercase hex letters to uppercase$final_checksum = '';for ($i = 0, $j = strlen($checksum); $i < $j; $i++) {    if ('0' == $checksum[$i]) {$final_checksum .='0';}	elseif ('1' == $checksum[$i]) {$final_checksum .='1';}	elseif ('2' == $checksum[$i]) {$final_checksum .='2';}	elseif ('3' == $checksum[$i]) {$final_checksum .='3';}	elseif ('4' == $checksum[$i]) {$final_checksum .='4';}	elseif ('5' == $checksum[$i]) {$final_checksum .='5';}	elseif ('6' == $checksum[$i]) {$final_checksum .='6';}	elseif ('7' == $checksum[$i]) {$final_checksum .='7';}	elseif ('8' == $checksum[$i]) {$final_checksum .='8';}	elseif ('9' == $checksum[$i]) {$final_checksum .='9';}	elseif ('a' == $checksum[$i]) {$final_checksum .='A';}	elseif ('b' == $checksum[$i]) {$final_checksum .='B';}	elseif ('c' == $checksum[$i]) {$final_checksum .='C';}	elseif ('d' == $checksum[$i]) {$final_checksum .='D';}	elseif ('e' == $checksum[$i]) {$final_checksum .='E';}	elseif ('f' == $checksum[$i]) {$final_checksum .='F';}}//If the checksum is only one character, then make it 2. Eg. make 8 into 08 or A into 0Aif (strlen($final_checksum)==1) {$new_final_checksum = '0';$new_final_checksum .= $final_checksum;$new_final_checksum = $final_checksum;}//The final string to be sent to the controller must now be assembled and sent:$string .=$final_checksum;$part5 = $final_checksum;$final_string = $part1 . $part2 . $part3 . chr(0) . $part4 . $part5 . chr(13);//Don't timeoutset_time_limit(0);//Socket connection info$host="10.0.1.230";  // ****REMEMBER read the IP file in case the host IP is not default$port = 5556;// open a client connection$fp = fsockopen ($host, $port, $errno, $errstr);if (!$fp){$result = "Error: could not open socket connection";}//Logon message$message = ">1D003003000001000107D0119435";$message .= chr(13);// write the string contained in $message to the socketfputs ($fp, $message);sleep(1);// get the result//$result = fgets ($fp, 64);//echo "The controller says: $result <br /><br />";//Keepalive message$message1 = ">0B00300748";$message1 .= chr(13);fputs ($fp, $message1);sleep(1);//$result1 = fgets ($fp, 64);//echo "The controller says: $result1 <br /><br />";//Send updated card data$message2 = $final_string;fputs ($fp, $message2);sleep(1);//$result2 = fgets ($fp, 64);//echo "The controller says: $result2";// close the connectionfclose ($fp);echo "<meta http-equiv='refresh' content='0;URL=person.php'>"; break;
}
?>
</font></div></div></div></body></html>